stage('Package') {
    steps {
        echo "Packaging ${SERVICE_NAME} (stable build)..."
        dir("${SERVICE_NAME}") {
            sh '''
              rm -rf /tmp/package-${SERVICE_NAME}
              mkdir -p /tmp/package-${SERVICE_NAME}

              rsync -a \
                --exclude=node_modules \
                --exclude=.git \
                --exclude=.npm \
                ./ /tmp/package-${SERVICE_NAME}/

              cd /tmp/package-${SERVICE_NAME}
              # Use --warning=no-file-changed to prevent tar from failing
              tar --warning=no-file-changed -czf ${SERVICE_NAME}.tar.gz .

              mv ${SERVICE_NAME}.tar.gz ${WORKSPACE}/${SERVICE_NAME}/
              rm -rf /tmp/package-${SERVICE_NAME}
            '''
        }
    }
}
