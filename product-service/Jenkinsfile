pipeline {
    agent any

    environment {
        SERVICE_NAME = 'product-service'
        SERVICE_PORT = '3000'
        AWS_REGION  = 'eu-west-2'
    }

    stages {

        stage('Verify Workspace') {
            steps {
                sh '''
                    echo "Workspace:"
                    pwd
                    ls -la
                '''
            }
        }

        stage('Package') {
            steps {
                dir("${SERVICE_NAME}") {
                    sh '''
                        echo "Packaging service..."
                        tar -czf ${SERVICE_NAME}.tar.gz .
                    '''
                }
            }
        }

        stage('Upload to S3') {
            steps {
                sh '''
                    aws s3 cp ${SERVICE_NAME}/${SERVICE_NAME}.tar.gz \
                        s3://richie-s3/deployments/${SERVICE_NAME}/ \
                        --region ${AWS_REGION}
                '''
            }
        }

        stage('Deploy via SSM') {
            steps {
                sh '''
                    for NAME in devops-ecommerce-app-1 devops-ecommerce-app-2; do
                      ID=$(aws ec2 describe-instances \
                        --filters "Name=tag:Name,Values=$NAME" \
                        --query "Reservations[0].Instances[0].InstanceId" \
                        --output text \
                        --region ${AWS_REGION})

                      aws ssm send-command \
                        --instance-ids "$ID" \
                        --document-name "AWS-RunShellScript" \
                        --parameters 'commands=[
                          "cd /tmp",
                          "aws s3 cp s3://richie-s3/deployments/product-service/product-service.tar.gz .",
                          "cd ~/services/product-service",
                          "tar -xzf /tmp/product-service.tar.gz",
                          "npm install --production",
                          "pm2 restart product-service || pm2 start server.js --name product-service"
                        ]' \
                        --region ${AWS_REGION}
                    done
                '''
            }
        }
    }

    post {
        always {
            deleteDir()
        }
    }
}
