pipeline {
    agent any

    environment {
        AWS_REGION = "eu-west-2"
        S3_BUCKET  = "ecommerce-deploy-artifacts"
        SERVICE_NAME = "order-service"
        PACKAGE_NAME = "order-service.tar.gz"

        SERVER_1 = "i-xxxxxxxxxxxxxxx"
        SERVER_2 = "i-yyyyyyyyyyyyyyy"
    }

    stages {

        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
            }
        }

        stage('Install Dependencies (Jenkins)') {
            steps {
                echo 'Creating virtual environment and installing dependencies...'
                dir('order-service') {
                    sh '''
                        python3 --version
                        python3 -m venv venv
                        . venv/bin/activate

                        pip install --upgrade pip
                        pip install -r requirements.txt
                    '''
                }
            }
        }

        stage('Package') {
            steps {
                echo 'Packaging application...'
                dir('order-service') {
                    sh '''
                        rm -f ${PACKAGE_NAME}
                        tar --exclude=venv -czf ${PACKAGE_NAME} app.py requirements.txt
                        ls -lh ${PACKAGE_NAME}
                    '''
                }
            }
        }

        stage('Upload to S3') {
            steps {
                echo 'Uploading artifact to S3...'
                dir('order-service') {
                    sh '''
                        aws s3 cp ${PACKAGE_NAME} s3://${S3_BUCKET}/${SERVICE_NAME}/${PACKAGE_NAME} \
                          --region ${AWS_REGION}
                    '''
                }
            }
        }

        stage('Deploy via SSM') {
            parallel {
                stage('Deploy to Server 1') {
                    steps {
                        sh """
                        aws ssm send-command \
                          --region ${AWS_REGION} \
                          --instance-ids ${SERVER_1} \
                          --document-name "AWS-RunShellScript" \
                          --parameters commands='[
                            "cd /opt/${SERVICE_NAME}",
                            "aws s3 cp s3://${S3_BUCKET}/${SERVICE_NAME}/${PACKAGE_NAME} .",
                            "tar -xzf ${PACKAGE_NAME}",
                            "source venv/bin/activate || python3 -m venv venv",
                            "pip install -r requirements.txt",
                            "systemctl restart ${SERVICE_NAME}"
                          ]'
                        """
                    }
                }

                stage('Deploy to Server 2') {
                    steps {
                        sh """
                        aws ssm send-command \
                          --region ${AWS_REGION} \
                          --instance-ids ${SERVER_2} \
                          --document-name "AWS-RunShellScript" \
                          --parameters commands='[
                            "cd /opt/${SERVICE_NAME}",
                            "aws s3 cp s3://${S3_BUCKET}/${SERVICE_NAME}/${PACKAGE_NAME} .",
                            "tar -xzf ${PACKAGE_NAME}",
                            "source venv/bin/activate || python3 -m venv venv",
                            "pip install -r requirements.txt",
                            "systemctl restart ${SERVICE_NAME}"
                          ]'
                        """
                    }
                }
            }
        }

        stage('Wait for Deployment') {
            steps {
                echo 'Waiting for service to stabilise...'
                sleep time: 20, unit: 'SECONDS'
            }
        }

        stage('Health Check') {
            steps {
                echo 'Running health check...'
                sh '''
                  curl -f http://order-service.internal/health || exit 1
                '''
            }
        }
    }

    post {
        success {
            echo 'Order service deployed successfully'
        }
        failure {
            echo 'Order service deployment failed'
        }
        always {
            deleteDir()
        }
    }
}
